# Анализ проекта FitMonster

**Дата:** 15.01.2026  
**Объект анализа:** текущий код в `lib/`, конфиги (`pubspec.yaml`, `analysis_options.yaml`) и документация в `docs/`.

## Резюме (1–2 минуты)

- **Стек:** Flutter (Dart SDK `^3.10.1`), локальное хранилище **Hive**, камера `camera`, ML **Google ML Kit Pose Detection**, графики `fl_chart`, auth-пакет `google_sign_in` (в коде фактически используется локальный `AuthService`).
- **Архитектура по структуре:** `lib/core/*` + `lib/features/*` (feature-first), навигация через `HomePage` (`IndexedStack` + `NavigationBar`).
- **Ключевая проблема №1 (функциональный баг):** в модуле диеты **расходятся userId при сохранении/чтении профиля**, из-за чего профиль может никогда не загрузиться.
- **Ключевая проблема №2 (устойчивость):** **две параллельные схемы работы с Hive** (через `HiveService` и напрямую через `Hive.openBox(...)`) и **неполная инициализация Hive в `main.dart`**.
- **Текущий статус по факту кода:** ядро диеты и упражнения есть, но слой состояния/DI почти отсутствует (provider подключен, но не применяется), профиль/статистика в UI частично на заглушках.

## 1) Текущее состояние реализации (по коду)

### Навигация и entrypoint
- Точка входа: `lib/main.dart` — инициализирует `Hive.initFlutter()` и запускает `HomePage`.
- Навигация: `lib/features/home/presentation/pages/home_page.dart` — вкладки **Упражнения / Диета / Профиль** через `IndexedStack`.

### Упражнения (камера/ML)
- Экран списка: `lib/features/exercises/presentation/pages/exercises_page.dart` — поиск, фильтры, детали упражнения, запуск камеры.
- Камера + MLKit: `lib/features/exercises/presentation/pages/exercise_camera_page.dart`
  - поток кадров `startImageStream()`, защита от перегрузки через `_isProcessing`.
  - подсчет повторений (сейчас заточен под механику приседаний по углам).
  - есть оверлей отрисовки позы `PosePainter`.
- Дополнительно: есть «псевдо-детекция» позы `lib/features/exercises/services/pose_detection_service.dart` (работает без ML Kit, но это не реальная pose detection).
- Есть отдельные сервисы анализа/подсчёта:
  - `lib/features/exercises/services/optimized_pose_detection_service.dart`
  - `lib/features/exercises/services/rep_counter_service.dart`
  - **Важно:** на текущий момент они не выглядят интегрированными в основной `ExerciseCameraPage` (там своя логика).

### Диета и трекер
- Стартовая страница: `lib/features/diet/presentation/pages/diet_page.dart` (показывает `FoodLogPage` если профиль есть).
- Профиль для калорий/макросов: `lib/features/diet/presentation/pages/profile_setup_page.dart`.
- Данные диеты: `lib/features/diet/domain/services/diet_service.dart` — прямой `Hive.openBox<UserProfile>('user_profile')` и `Hive.openBox<FoodLog>('food_logs')`.

### Профиль/статистика/авторизация
- `lib/core/services/auth_service.dart` — локальная сессия на Hive (`settingsBox/current_user_id`), не Firebase.
- `lib/core/services/stats_service.dart` — хранит `UserStats` в Hive (`userBox`), обновляет streak.
- `lib/features/profile/presentation/pages/profile_page.dart` — **UI использует заглушечный `LocalStatsService`** и хранит `_isAuthenticated` локально в State, без реального `restoreSession()`.

## 2) Критичные проблемы (влияние на пользователя)

### 2.1. Несовпадение userId в диете (высокий приоритет)

**Симптом:** пользователь заполняет профиль, нажимает «Сохранить профиль», но `DietPage` продолжает считать, что профиля нет.

**Причина (по коду):**
- `DietService.getUserProfile()` всегда читает по ключу `local_user`.
- `ProfileSetupPage` создаёт профиль с `userId = 'guest'` (пока Firebase не настроен) и сохраняет его.

**Риск:** «Диета» выглядит неработающей, данные «теряются».

### 2.2. Неконсистентная инициализация/использование Hive (высокий приоритет)

**Что происходит:**
- В проекте есть `HiveService.initialize()` с регистрацией адаптеров и открытием боксов (`user/workouts/meals/settings`).
- Но `main.dart` вызывает только `Hive.initFlutter()` и не регистрирует адаптеры/боксы через `HiveService`.
- При этом модуль диеты вообще использует отдельные боксы (`user_profile`, `food_logs`) и открывает их напрямую.

**Риски:**
- падения/исключения при сериализации Hive-объектов (если адаптеры не зарегистрированы).
- разный способ хранения данных в разных модулях → сложнее синхронизировать и тестировать.

## 3) Архитектура и техдолг

### 3.1. Состояние/DI
- `provider` подключен, но **не используется**: нет `MultiProvider`, `ChangeNotifierProvider`, `context.watch/read`.
- Сервисы используются как singletons или создаются прямо в виджетах → слабая тестируемость и сложнее управлять жизненным циклом.

### 3.2. Дублирование моделей/логики
- Есть 2 разных «вектора» для статистики:
  - `lib/core/models/user_stats.dart` (реальная модель + `StatsService`)
  - `lib/features/profile/presentation/pages/profile_page.dart` (локальная заглушка `UserStats`/`LocalStatsService`)
- В упражнениях есть несколько параллельных подходов к анализу (ML Kit vs псевдо-детектор/оптимизированный анализ), но интеграция не унифицирована.

### 3.3. Firebase
- В документах активно фигурирует Firebase, но **в `pubspec.yaml` нет пакетов Firebase**, и в коде нет реальной интеграции.
- Это нормально для офлайн-MVP, но важно синхронизировать ожидания документации и фактического состояния.

## 4) Риски по производительности и стабильности (ML/камера)

- Реальный bottleneck обычно в конвертации `CameraImage` → `InputImage` и частоте обработки.
- В `ExerciseCameraPage` есть throttling через `_isProcessing`, но присутствует массивная отладочная печать в каждом кадре (`print(...)`) — на реальных устройствах это может заметно «убить» FPS.
- В `PoseDetectionService` (псевдо-детектор) есть конвертация YUV→RGB в двойном цикле по пикселям — это **очень дорого** и в проде не годится без SIMD/изоляции/уменьшения размеров.

## 5) Рекомендации (по приоритету)

### P0 — исправить сейчас (блокеры UX)
- **Унифицировать userId для диеты**: один источник истины (локальный userId/guestId) + одинаковый ключ при `save/get`.
- **Единая инициализация Hive при старте**:
  - либо использовать только `HiveService.initialize()` в `main.dart`,
  - либо явно регистрировать адаптеры и продумать список боксов, если диета остаётся на отдельных боксах.
- **Профиль/статистика:** убрать заглушечный `LocalStatsService` или явно пометить как мок и подключить `StatsService` + `AuthService.restoreSession()`.

### P1 — улучшить качество кода и сопровождение
- Ввести DI (хотя бы `provider`/`get_it`) для сервисов: `AuthService`, `StatsService`, `WorkoutService`, `DietService`.
- Привести к одному стилю данных: доменные модели + один слой storage (Hive адаптеры) вместо Map/динамики.
- Сократить/загейтить `print`-логирование (например, через `kDebugMode`).

### P2 — продуктовые улучшения (по backlog)
- Закрыть US-003/US-004/US-005: расширенный анализ техники, унифицированный подсчёт повторений, управление тренировкой (пауза/стоп/сеты).
- Диета US-007: генерация плана с учётом аллергий/противопоказаний (данные уже собираются).

## 6) Быстрые проверки (ручные сценарии)

- **Диета:** создать профиль → вернуться на вкладку «Диета» → убедиться, что открывается `FoodLogPage` и макросы рассчитаны.
- **Упражнения:** открыть камеру → 10–15 сек → убедиться, что UI не «фризит», FPS стабилен, повторения считаются.
- **Сессия:** закрыть/открыть приложение → проверить восстановление пользователя (`restoreSession`) и доступность истории тренировок.

---

Если нужно, могу на базе этого анализа сразу:
1) поправить `userId` в диете,  
2) унифицировать инициализацию Hive в `main.dart`,  
3) подключить реальные `AuthService/StatsService` в UI профиля.

